# OAuth Entegrasyonu - Gmail ve Outlook

## üìã ƒ∞√ßindekiler

1. [Genel Bakƒ±≈ü](#genel-bakƒ±≈ü)
2. [Desteklenen Provider'lar](#desteklenen-providerlar)
3. [Konfig√ºrasyon](#konfig√ºrasyon)
4. [API Endpoint'leri](#api-endpointleri)
5. [Kullanƒ±m √ñrnekleri](#kullanƒ±m-√∂rnekleri)
6. [G√ºvenlik](#g√ºvenlik)
7. [Troubleshooting](#troubleshooting)
8. [Best Practices](#best-practices)

---

## üîê Genel Bakƒ±≈ü

Prospect CRM sistemi, Gmail ve Outlook email hesaplarƒ±nƒ± OAuth2 protokol√º ile g√ºvenli bir ≈üekilde baƒülamanƒ±zƒ± saƒülar. Bu entegrasyon sayesinde:

- **G√ºvenli Baƒülantƒ±:** ≈ûifre payla≈ümadan email hesaplarƒ±na eri≈üim
- **Token Y√∂netimi:** Otomatik token yenileme ve y√∂netimi
- **Email G√∂nderimi:** Gmail API ve Microsoft Graph API ile email g√∂nderimi
- **√áoklu Hesap:** Birden fazla email hesabƒ±nƒ± aynƒ± anda baƒülama

### Avantajlarƒ±

- ‚úÖ **G√ºvenli:** OAuth2 protokol√º ile g√ºvenli kimlik doƒürulama
- ‚úÖ **Kolay:** Basit API endpoint'leri ile kolay entegrasyon
- ‚úÖ **Otomatik:** Token yenileme ve y√∂netimi otomatik
- ‚úÖ **√áoklu:** Gmail ve Outlook desteƒüi
- ‚úÖ **Monitoring:** Detaylƒ± loglama ve monitoring

---

## üè¢ Desteklenen Provider'lar

### 1. Google Gmail
- **Provider Code:** `google`
- **API:** Gmail API v1
- **Scopes:** 
  - `https://www.googleapis.com/auth/gmail.send`
  - `https://www.googleapis.com/auth/gmail.readonly`
  - `openid`, `profile`, `email`

### 2. Microsoft Outlook
- **Provider Code:** `microsoft`
- **API:** Microsoft Graph API v1.0
- **Scopes:**
  - `https://graph.microsoft.com/Mail.Send`
  - `https://graph.microsoft.com/Mail.Read`
  - `openid`, `profile`, `email`, `offline_access`

---

## ‚öôÔ∏è Konfig√ºrasyon

### 1. Application Properties

```properties
# OAuth2 Configuration
# Gmail OAuth2
spring.security.oauth2.client.registration.google.client-id=your-google-client-id
spring.security.oauth2.client.registration.google.client-secret=your-google-client-secret
spring.security.oauth2.client.registration.google.scope=openid,profile,email,https://www.googleapis.com/auth/gmail.send,https://www.googleapis.com/auth/gmail.readonly
spring.security.oauth2.client.registration.google.redirect-uri={baseUrl}/v1/oauth/callback/google

# Microsoft OAuth2 (Outlook)
spring.security.oauth2.client.registration.microsoft.client-id=your-microsoft-client-id
spring.security.oauth2.client.registration.microsoft.client-secret=your-microsoft-client-secret
spring.security.oauth2.client.registration.microsoft.scope=openid,profile,email,offline_access,https://graph.microsoft.com/Mail.Send,https://graph.microsoft.com/Mail.Read
spring.security.oauth2.client.registration.microsoft.redirect-uri={baseUrl}/v1/oauth/callback/microsoft

# OAuth2 Provider Configuration
oauth.google.authorization-uri=https://accounts.google.com/o/oauth2/v2/auth
oauth.google.token-uri=https://oauth2.googleapis.com/token
oauth.google.user-info-uri=https://www.googleapis.com/oauth2/v3/userinfo
oauth.google.gmail-api-uri=https://gmail.googleapis.com/gmail/v1

oauth.microsoft.authorization-uri=https://login.microsoftonline.com/common/oauth2/v2.0/authorize
oauth.microsoft.token-uri=https://login.microsoftonline.com/common/oauth2/v2.0/token
oauth.microsoft.user-info-uri=https://graph.microsoft.com/v1.0/me
oauth.microsoft.graph-api-uri=https://graph.microsoft.com/v1.0

# OAuth Token Settings
oauth.token.expiration-buffer=300
oauth.refresh.threshold=600
```

### 2. Google Cloud Console Setup

1. **Google Cloud Console'a gidin:** https://console.cloud.google.com/
2. **Yeni proje olu≈üturun** veya mevcut projeyi se√ßin
3. **OAuth consent screen** olu≈üturun
4. **Credentials > OAuth 2.0 Client IDs** olu≈üturun
5. **Authorized redirect URIs** ekleyin:
   - `http://localhost:8080/v1/oauth/callback/google` (development)
   - `https://yourdomain.com/v1/oauth/callback/google` (production)

### 3. Microsoft Azure Setup

1. **Azure Portal'a gidin:** https://portal.azure.com/
2. **App registrations** olu≈üturun
3. **Authentication** ayarlarƒ±nƒ± yapƒ±n
4. **Redirect URIs** ekleyin:
   - `http://localhost:8080/v1/oauth/callback/microsoft` (development)
   - `https://yourdomain.com/v1/oauth/callback/microsoft` (production)
5. **API permissions** ekleyin:
   - `Mail.Send`
   - `Mail.Read`

---

## üåê API Endpoint'leri

### OAuth Endpoints

#### 1. OAuth Provider'larƒ±nƒ± Listele
```http
GET /v1/oauth/providers
Authorization: Bearer {jwt_token}
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "code": "google",
      "name": "Gmail",
      "description": "Google Gmail OAuth2"
    },
    {
      "code": "microsoft",
      "name": "Outlook",
      "description": "Microsoft Outlook OAuth2"
    }
  ],
  "message": "OAuth providers retrieved successfully"
}
```

#### 2. OAuth Authorization URL Olu≈ütur
```http
POST /v1/oauth/authorize
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "provider": "google",
  "email": "user@gmail.com",
  "redirectUri": "http://localhost:3000/oauth/callback"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "authorizationUrl": "https://accounts.google.com/o/oauth2/v2/auth?client_id=...",
    "state": "random-state-string",
    "provider": "google"
  },
  "message": "Authorization URL created successfully"
}
```

#### 3. OAuth Callback
```http
GET /v1/oauth/callback/google?code=authorization_code&state=state&userId=1001
```

**Response:**
```json
{
  "success": true,
  "data": {
    "provider": "google",
    "email": "user@gmail.com",
    "status": "CONNECTED",
    "connectedAt": "2024-01-01T10:00:00",
    "expiresAt": "2024-01-01T12:00:00",
    "scopes": ["openid", "profile", "email", "https://www.googleapis.com/auth/gmail.send"],
    "accessToken": "ya29.a0...",
    "refreshToken": "1//04..."
  },
  "message": "OAuth connection successful"
}
```

#### 4. Baƒülƒ± Hesaplarƒ± Listele
```http
GET /v1/oauth/accounts?userId=1001
Authorization: Bearer {jwt_token}
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "provider": "google",
      "email": "user@gmail.com",
      "status": "CONNECTED",
      "connectedAt": "2024-01-01T10:00:00",
      "expiresAt": "2024-01-01T12:00:00",
      "scopes": ["openid", "profile", "email", "https://www.googleapis.com/auth/gmail.send"]
    },
    {
      "provider": "microsoft",
      "email": "user@outlook.com",
      "status": "CONNECTED",
      "connectedAt": "2024-01-01T11:00:00",
      "expiresAt": "2024-01-01T13:00:00",
      "scopes": ["openid", "profile", "email", "https://graph.microsoft.com/Mail.Send"]
    }
  ],
  "message": "Connected accounts retrieved successfully"
}
```

#### 5. Hesap Baƒülantƒ±sƒ±nƒ± Kes
```http
DELETE /v1/oauth/disconnect?userId=1001&provider=google&email=user@gmail.com
Authorization: Bearer {jwt_token}
```

**Response:**
```json
{
  "success": true,
  "data": "Account disconnected successfully",
  "message": "Account disconnected successfully"
}
```

#### 6. OAuth Durumu Kontrol Et
```http
GET /v1/oauth/status?userId=1001
Authorization: Bearer {jwt_token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "userId": 1001,
    "connectedAccounts": 2,
    "accounts": [...],
    "hasGmail": true,
    "hasOutlook": true
  },
  "message": "OAuth status retrieved successfully"
}
```

### Email Endpoints

#### 1. Email G√∂nder
```http
POST /v1/emails/send
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "provider": "google",
  "fromEmail": "user@gmail.com",
  "toEmails": ["recipient@example.com"],
  "ccEmails": ["cc@example.com"],
  "bccEmails": ["bcc@example.com"],
  "subject": "Test Email",
  "body": "<h1>Hello World</h1><p>This is a test email.</p>",
  "contentType": "text/html",
  "attachments": [
    {
      "fileName": "document.pdf",
      "contentType": "application/pdf",
      "base64Content": "JVBERi0xLjQK..."
    }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "data": "Email sent successfully",
  "message": "Email sent successfully"
}
```

#### 2. SMTP ile Email G√∂nder (Fallback)
```http
POST /v1/emails/send-smtp
Authorization: Bearer {jwt_token}
Content-Type: application/x-www-form-urlencoded

fromEmail=user@gmail.com&password=app_password&toEmails=recipient@example.com&subject=Test&body=Hello&contentType=text/plain
```

#### 3. Email Template Render Et
```http
POST /v1/emails/render-template?templateName=welcome
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "name": "John Doe",
  "username": "johndoe"
}
```

**Response:**
```json
{
  "success": true,
  "data": "<html><body><h1>Ho≈ü Geldiniz!</h1><p>Merhaba John Doe,</p>...</body></html>",
  "message": "Template rendered successfully"
}
```

#### 4. Email Template'lerini Listele
```http
GET /v1/emails/templates
Authorization: Bearer {jwt_token}
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "name": "welcome",
      "description": "Ho≈ü geldiniz email template'i"
    },
    {
      "name": "lead_followup",
      "description": "Lead takip email template'i"
    }
  ],
  "message": "Email templates retrieved successfully"
}
```

#### 5. Email Durumu Kontrol Et
```http
GET /v1/emails/status?userId=1001
Authorization: Bearer {jwt_token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "userId": 1001,
    "canSendEmail": true,
    "supportedProviders": ["Gmail", "Outlook"],
    "message": "Email service is available"
  },
  "message": "Email status retrieved successfully"
}
```

---

## üí° Kullanƒ±m √ñrnekleri

### 1. Gmail Hesabƒ± Baƒülama

```javascript
// 1. Authorization URL al
const response = await fetch('/v1/oauth/authorize', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + jwtToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    provider: 'google',
    email: 'user@gmail.com'
  })
});

const { data } = await response.json();

// 2. Kullanƒ±cƒ±yƒ± OAuth sayfasƒ±na y√∂nlendir
window.location.href = data.authorizationUrl;

// 3. Callback'te token'larƒ± al
// Bu otomatik olarak /v1/oauth/callback/google endpoint'inde i≈ülenir
```

### 2. Email G√∂nderme

```javascript
// Gmail ile email g√∂nder
const emailResponse = await fetch('/v1/emails/send', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + jwtToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    provider: 'google',
    fromEmail: 'user@gmail.com',
    toEmails: ['recipient@example.com'],
    subject: 'Lead Takip',
    body: '<h1>Merhaba</h1><p>Lead takip email'i.</p>',
    contentType: 'text/html'
  })
});
```

### 3. Template ile Email G√∂nderme

```javascript
// Template render et
const templateResponse = await fetch('/v1/emails/render-template?templateName=lead_followup', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + jwtToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    leadName: 'John Doe',
    companyName: 'ABC Company',
    senderName: 'Sales Team'
  })
});

const { data: emailBody } = await templateResponse.json();

// Email g√∂nder
await fetch('/v1/emails/send', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + jwtToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    provider: 'google',
    fromEmail: 'user@gmail.com',
    toEmails: ['john.doe@abc.com'],
    subject: 'Lead Takip',
    body: emailBody,
    contentType: 'text/html'
  })
});
```

---

## üîí G√ºvenlik

### 1. Token G√ºvenliƒüi

- **Access Token:** Kƒ±sa s√ºreli (1-2 saat)
- **Refresh Token:** Uzun s√ºreli (7-30 g√ºn)
- **Token Storage:** Veritabanƒ±nda ≈üifrelenmi≈ü
- **Token Rotation:** Otomatik yenileme

### 2. OAuth G√ºvenliƒüi

- **State Parameter:** CSRF korumasƒ±
- **PKCE:** Code challenge (opsiyonel)
- **Scope Validation:** Minimum gerekli izinler
- **Redirect URI Validation:** G√ºvenli callback URL'leri

### 3. Email G√ºvenliƒüi

- **HTTPS:** T√ºm ileti≈üim ≈üifreli
- **API Keys:** G√ºvenli API anahtarlarƒ±
- **Rate Limiting:** API rate limiting
- **Content Validation:** Email i√ßerik doƒürulama

### 4. Monitoring ve Logging

- **Security Logs:** OAuth i≈ülemleri loglanƒ±r
- **Error Tracking:** Hata durumlarƒ± izlenir
- **Performance Monitoring:** API performansƒ± √∂l√ß√ºl√ºr
- **Audit Trail:** T√ºm i≈ülemler kaydedilir

---

## üîß Troubleshooting

### Yaygƒ±n Sorunlar

#### 1. "Invalid Client" Hatasƒ±
**Semptom:** OAuth callback'te "invalid_client" hatasƒ±
**√á√∂z√ºm:**
- Client ID ve Client Secret'ƒ± kontrol edin
- Redirect URI'nin doƒüru olduƒüundan emin olun
- Google Cloud Console'da OAuth consent screen'i kontrol edin

#### 2. "Invalid Scope" Hatasƒ±
**Semptom:** "invalid_scope" hatasƒ±
**√á√∂z√ºm:**
- Scope'larƒ±n doƒüru yazƒ±ldƒ±ƒüƒ±ndan emin olun
- Google Cloud Console'da gerekli API'leri etkinle≈ütirin
- Azure Portal'da API permissions'larƒ± kontrol edin

#### 3. "Token Expired" Hatasƒ±
**Semptom:** Email g√∂nderirken token expired hatasƒ±
**√á√∂z√ºm:**
- Token otomatik yenilenir, tekrar deneyin
- Refresh token'ƒ±n ge√ßerli olduƒüundan emin olun
- Gerekirse hesabƒ± yeniden baƒülayƒ±n

#### 4. "Permission Denied" Hatasƒ±
**Semptom:** Email g√∂nderirken permission denied
**√á√∂z√ºm:**
- OAuth consent screen'de gerekli izinleri verin
- Gmail API'yi etkinle≈ütirin
- Microsoft Graph API permissions'larƒ± kontrol edin

### Debug Modu

```properties
# Debug logging
logging.level.com.prospect.crm.service.OAuthService=DEBUG
logging.level.com.prospect.crm.service.EmailService=DEBUG
logging.level.org.springframework.security.oauth2=DEBUG
```

### Test Endpoint'leri

```http
# OAuth durumu test et
GET /v1/oauth/status?userId=1001

# Email durumu test et
GET /v1/emails/status?userId=1001

# Template test et
POST /v1/emails/render-template?templateName=welcome
```

---

## üìã Best Practices

### 1. OAuth Y√∂netimi

- ‚úÖ **Scope Minimization:** Sadece gerekli izinleri isteyin
- ‚úÖ **Token Rotation:** D√ºzenli token yenileme
- ‚úÖ **Error Handling:** Graceful error handling
- ‚úÖ **Monitoring:** OAuth i≈ülemlerini izleyin

### 2. Email G√∂nderimi

- ‚úÖ **Rate Limiting:** API rate limit'lerini a≈ümayƒ±n
- ‚úÖ **Content Validation:** Email i√ßeriƒüini doƒürulayƒ±n
- ‚úÖ **Template Usage:** Template'leri kullanƒ±n
- ‚úÖ **Error Handling:** Email g√∂nderim hatalarƒ±nƒ± yakalayƒ±n

### 3. G√ºvenlik

- ‚úÖ **HTTPS:** T√ºm ileti≈üimde HTTPS kullanƒ±n
- ‚úÖ **Token Security:** Token'larƒ± g√ºvenli saklayƒ±n
- ‚úÖ **Input Validation:** T√ºm input'larƒ± doƒürulayƒ±n
- ‚úÖ **Logging:** G√ºvenlik loglarƒ±nƒ± tutun

### 4. Performance

- ‚úÖ **Caching:** Token'larƒ± cache'leyin
- ‚úÖ **Async Processing:** Email g√∂nderimini async yapƒ±n
- ‚úÖ **Batch Operations:** Toplu email g√∂nderimi
- ‚úÖ **Monitoring:** Performans metriklerini izleyin

### 5. User Experience

- ‚úÖ **Clear Instructions:** Kullanƒ±cƒ±lara net talimatlar verin
- ‚úÖ **Error Messages:** Anla≈üƒ±lƒ±r hata mesajlarƒ±
- ‚úÖ **Progress Indicators:** ƒ∞≈ülem durumunu g√∂sterin
- ‚úÖ **Fallback Options:** SMTP fallback saƒülayƒ±n

---

## üìö Ek Kaynaklar

### OAuth2 Dok√ºmanlarƒ±
- [OAuth 2.0 RFC](https://tools.ietf.org/html/rfc6749)
- [Google OAuth2](https://developers.google.com/identity/protocols/oauth2)
- [Microsoft OAuth2](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow)

### API Dok√ºmanlarƒ±
- [Gmail API](https://developers.google.com/gmail/api)
- [Microsoft Graph API](https://docs.microsoft.com/en-us/graph/)

### G√ºvenlik Rehberleri
- [OAuth2 Security Best Practices](https://oauth.net/2/oauth-best-practice/)
- [Google OAuth Security](https://developers.google.com/identity/protocols/oauth2/web-security)
- [Microsoft OAuth Security](https://docs.microsoft.com/en-us/azure/active-directory/develop/security-best-practices-for-app-registration)

---

## üìû Destek

### ƒ∞leti≈üim
- **Email:** support@prospect-crm.com
- **Documentation:** https://docs.prospect-crm.com
- **GitHub:** https://github.com/prospect-crm

### Katkƒ±da Bulunma
1. Fork yapƒ±n
2. Feature branch olu≈üturun
3. Deƒüi≈üikliklerinizi commit edin
4. Pull request g√∂nderin

### Lisans
Bu proje MIT lisansƒ± altƒ±nda lisanslanmƒ±≈ütƒ±r. Detaylar i√ßin [LICENSE](LICENSE) dosyasƒ±na bakƒ±n. 